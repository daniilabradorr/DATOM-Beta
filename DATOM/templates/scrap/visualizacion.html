{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Visualizaci√≥n de los datos de Scrap del departamento de Montaje de DATOM">
    <meta name="author" content="Daniel Labrador Benito">
    <title>Visualizaci√≥n de Defectos</title>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'favicon/favicon.ico' %}" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'favicon/site.webmanifest' %}">

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <!-- Estilos -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f6f9; /* Color de fondo */
            margin: 0;
            padding: 0;
        }

        .container {
            width: 95%;
            margin: auto; /* Centra el contenido */
            padding-top: 20px; /* Espacio en la parte superior */
        }

        header {
            text-align: center; /* Centra el contenido dentro del header */
            margin-bottom: 10px; /* Espacio inferior */
        }

        header img {
            margin-top: 20px; /* Espacio superior para la imagen */
            width: 200px; /* Ancho de la imagen */
            margin-bottom: 0; /* Espacio inferior para la imagen */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.8); /* Sombra sutil alrededor de la imagen */
            border-radius: 16px; /* Bordes redondeados */
        }

        h1 {
            font-size: 2.5rem; /* Tama√±o de fuente para el t√≠tulo */
            color: #333; /* Color del texto */
            text-align: center;        
        }

        .charts-wrapper {
            display: grid; /* Utiliza un grid para organizar los gr√°ficos */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* M√∫ltiples columnas que se ajustan autom√°ticamente */
            gap: 20px; /* Espacio entre los elementos */
            padding: 20px 0;
        }

        .chart-container {
            background-color: #fff; /* Fondo blanco para el contenedor */
            padding: 30px; /* Espaciado dentro del contenedor */
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.8); /* Sombra sutil */
        }

        .chart-container h2 {
            font-size: 1.5rem; /* Tama√±o de fuente para los subt√≠tulos */
            color: #007bff; /* Color azul para el t√≠tulo */
            text-align: center; /* Centra el subt√≠tulo */
            margin-bottom: 20px; /* Espacio inferior */
        }
 

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff; /* Fondo azul */
            color: white; /* Color blanco para el texto */
            text-decoration: none; /* Elimina el subrayado */
            border-radius: 5px; /* Bordes redondeados para el bot√≥n */
            text-align: center; /* Centra el texto en el bot√≥n */
        }

        .btn-secondary {
            background-color: #6c757d; /* Fondo gris para el bot√≥n secundario */
        }

        .highcharts-figure {
            width: 100%;
            height: 400px; /* Establece una altura para los gr√°ficos */
        }

        /* Estilo para el gr√°fico general */
        .chart-general-container {
            background-color: #fff; /* Fondo blanco */
            padding: 30px; /* Espaciado dentro del contenedor */
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Sombra sutil */
            width: 97%;
            margin-bottom: 10px; /* Espacio inferior */
            margin-right: 10px;
        }

        .highcharts-title {
            color: #007bff; /* Color azul para el t√≠tulo */
            font-size: 2rem; /* Tama√±o de fuente grande */
            text-align: center; /* Centra el t√≠tulo */
        }

        .highcharts-tooltip {
            background-color: #007bff; /* Fondo azul para el tooltip */
            color: white; /* Color blanco para el texto */
            border-radius: 5px; /* Bordes redondeados */
        }

        /* Responsividad para pantallas peque√±as */
        @media (max-width: 768px) {
            .charts-wrapper {
                grid-template-columns: 1fr; /* Cambia la disposici√≥n de las columnas a una sola en pantallas peque√±as */
            }

            .chart-general-container {
                padding: 20px; /* Reduce el espaciado dentro del contenedor */
            }
        }
    </style>
</head>

<body>
    <header>
        <a href="{% url 'core:home' %}">
            <img src="{% static 'img/core/logo_DATOM2.png' %}" alt="Logotipo de OPMobility">
        </a>
    </header>

    <div class="container">
        <h1>Visualizaci√≥n de los Datos de Scrap de Mantenimiento</h1>

        <div class="charts-wrapper">
            <!-- Gr√°fico 1: Defectos por Proyecto -->
            <div class="chart-container">
                <h2>Cantidad de Defectos por Proyecto</h2>
                <div id="chart-proyecto" class="highcharts-figure"></div>
            </div>

            <!-- Gr√°fico 2: Defectos por Tipo -->
            <div class="chart-container">
                <h2>Cantidad de Defectos por Tipo de Defecto</h2>
                <div id="chart-tipo" class="highcharts-figure"></div>
            </div>

            <!-- Gr√°fico 3: Datos Introducidos por T√©cnico -->
            <div class="chart-container">
                <h2>Cantidad Datos Introducidos T√©cnicos</h2>
                <div id="chart-usuario" class="highcharts-figure"></div>
            </div>

            <!-- Gr√°fico 4: Distribuci√≥n de Defectos por Tipo -->
            <div class="chart-container">
                <h2>Distribuci√≥n de Defectos por Tipo</h2>
                <div id="chart-pastel" class="highcharts-figure"></div>
            </div>

        </div>

        <!-- Gr√°fico General de Todos los Defectos -->
        <div class="chart-general-container">
            <h2>Gr√°fico General de Todos los Defectos (√Åreas Apiladas)</h2>
            <div id="chart-general" class="highcharts-figure"></div>
        </div>

        <!-- Bot√≥n de navegaci√≥n -->
        <div class="mt-4">
            <a href="{% url 'scrap:scrap_home' %}" class="btn btn-secondary">Volver Atr√°s</a>
        </div>
    </div>

    <!-- Scripts para los gr√°ficos -->
    <!-- Gr√°fico 1: Defectos por Proyecto ‚Äî ahora usa % scrap -->
    <script>
        Highcharts.chart('chart-proyecto', {
        chart: { type: 'column', backgroundColor: '#f4f6f9' },
        title: { text: 'Scrap por Proyecto (%)', style:{ color:'#007bff', fontWeight:'bold' } },

        xAxis: { categories: {{ proyectos_keys|safe }}, title:{ text:'Proyecto' } },
        yAxis: {
            max: 120,
            title:{ text:'% Scrap' },
            plotBands:[
            { from: 0,   to: 50,  color:'rgba(85,191,59,.07)'  },  // verde
            { from: 50,  to:100, color:'rgba(255,165,0,.07)'  },  // naranja
            { from: 100, to:120, color:'rgba(223,83,83,.07)'  }   // rojo
            ],
            plotLines:[
            { value: 50,  color:'#FFA500', width:2, dashStyle:'ShortDash',
                label:{ text:'Umbral 50 %', style:{ color:'#FFA500', fontWeight:'bold' } } },
            { value: 100, color:'#DF5353', width:2,
                label:{ text:'Cr√≠tico 100 %', style:{ color:'#DF5353', fontWeight:'bold' } } }
            ]
        },

        series:[{
            name:'% Scrap',
            data: {{ proyectos_pct_values|safe }},     // <-- lista de porcentajes 0-100
            zones:[
            { value: 50,  color:'#55BF3B' },   // verde
            { value:100,  color:'#FFA500' },   // naranja
            {              color:'#DF5353' }   // rojo
            ],
            zoneAxis:'y'
        }],
        tooltip:{ valueSuffix:' %' }
        });

        /* Avisos globales para este dashboard */
        (function(){
        const datos = {{ proyectos_pct_values|safe }};
        if (datos.some(v => v >= 100)) {
            alert('üü• ¬°Scrap cr√≠tico en alg√∫n proyecto (‚â•100 %)! Revisar producci√≥n.');
        } else if (datos.some(v => v >= 50)) {
            alert('üüß Aviso: uno o m√°s proyectos superan el 50 % de scrap.');
        }
        })();

        // Gr√°fico de Defectos por Tipo
        Highcharts.chart('chart-tipo', {
            chart: {
                type: 'column',
                backgroundColor: '#f4f6f9',
                borderColor: '#007bff',
                borderWidth: 2,
                borderRadius: 10
            },
            title: {
                text: 'Defectos por Tipo de Defecto',
                style: {
                    color: '#007bff',
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                categories: {{ defectos_por_tipo_keys|safe }},
                crosshair: true,
                title: {
                    text: 'Tipos de Defecto'
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Cantidad de Defectos'
                }
            },
            tooltip: {
                valueSuffix: ' Defectos',
                backgroundColor: '#007bff',
                borderRadius: 5,
                style: {
                    color: 'white'
                }
            },
            series: [{
                name: 'Defectos',
                data: {{ defectos_por_tipo_values|safe }},
                color: '#ffc107'
            }]
        });

        // Gr√°fico de Datos Introducidos por Usuario
        Highcharts.chart('chart-usuario', {
            chart: {
                type: 'column',
                backgroundColor: '#f4f6f9',
                borderColor: '#007bff',
                borderWidth: 2,
                borderRadius: 10
            },
            title: {
                text: 'Datos Introducidos por T√©cnico/Usuario',
                style: {
                    color: '#007bff',
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                categories: {{ datos_por_usuario_keys|safe }},
                crosshair: true,
                title: {
                    text: 'T√©cnicos/Usuarios'
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Cantidad de Datos Introducidos'
                }
            },
            tooltip: {
                valueSuffix: ' Datos',
                backgroundColor: '#007bff',
                style: {
                    color: 'white'
                }
            },
            series: [{
                name: 'Datos Introducidos',
                data: {{ datos_por_usuario_values|safe }},
                color: '#28a745'
            }]
        });

        // Gr√°fico de Distribuci√≥n de Defectos por Tipo (Gr√°fico de Pastel)
        Highcharts.chart('chart-pastel', {
            chart: {
                type: 'pie'
            },
            title: {
                text: 'Distribuci√≥n de Defectos por Tipo',
                style: {
                    color: '#007bff',
                    fontWeight: 'bold'
                }
            },
            tooltip: {
                pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>',
                backgroundColor: '#007bff',
                style: {
                    color: 'white'
                }
            },
            series: [{
                name: 'Defectos',
                colorByPoint: true,
                data: {{ defectos_por_tipo_percent_keys|safe }}.map((key, i) => {
                    return {
                        name: key,
                        y: {{ defectos_por_tipo_percent_values|safe }}[i],
                    };
                })
            }]
        });

        // Gr√°fico General (√Åreas Apiladas)
        Highcharts.chart('chart-general', {
            chart: {
                type: 'area'
            },
            title: {
                text: 'Gr√°fico General de Todos los Defectos',
                style: {
                    color: '#007bff',
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                categories: {{ defectos_por_proyecto_keys|safe }},
                title: {
                    text: 'Categor√≠as'
                }
            },
            yAxis: {
                title: {
                    text: 'Cantidad de Defectos'
                }
            },
            tooltip: {
                shared: true,
                valueSuffix: ' Defectos',
                backgroundColor: '#007bff',
                style: {
                    color: 'white'
                }
            },
            series: [{
                name: 'Defectos por Proyecto',
                data: {{ defectos_por_proyecto_values|safe }},
                color: '#28a745'
            }, {
                name: 'Defectos por Tipo',
                data: {{ defectos_por_tipo_values|safe }},
                color: '#ffc107'
            }, {
                name: 'Datos Introducidos por Usuario',
                data: {{ datos_por_usuario_values|safe }},
                color: '#007bff'
            }]
        });
    </script>
</body>
</html>
